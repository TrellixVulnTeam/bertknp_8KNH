#!/usr/bin/env bash

usage() {
  echo "Usage: echo sentence | $0 [-v] [-b BERT_MODEL] [-m BERT_PARSING_MODEL_DIR] [-P BERT_PARSING_COMMAND] [-o BERT_PARSING_OPTIONS] [-O BERT_PARSING_OPTIONS_FROM_FILE] [-p PYTHON_COMMAND] [-tab] [-pyknp]"
  exit 1
}

version() {
  echo "$VERSION"
  exit 0
}

VERSION="berknp 0.22"
BASE_DIR=$(dirname "$0")/..
echo "$BASE_DIR" | grep -q '^/' &>/dev/null
if [ $? -ne 0 ]; then
  BASE_DIR=$(pwd)/$BASE_DIR
fi

BERT_PARSING_COMMAND=$BASE_DIR/repo/pytorch-pretrained-bert-parsing/examples/run_parsing.py
BERT_MODEL=$BASE_DIR/pretrained_model
BERT_PARSING_MODEL_DIR=$BASE_DIR/model/latest
POS_LIST=$BASE_DIR/repo/pytorch-pretrained-bert-parsing/examples/pos.list
BERT_PARSING_OPTIONS="--max_seq_length 192 --prediction_result_filename - --do_predict --parsing --pos_list $POS_LIST --knp_mode"
BERT_PARSING_OUTPUT_OPTIONS="--output_tree"

PYTHON_COMMAND=python3

for OPT in "$@"; do
  case $OPT in
  -r)
    if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
      echo "$0: option requires an argument -- $1" 1>&2
      exit 1
    fi
    shift 1
    ;;
  -b)
    if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
      echo "$0: option requires an argument -- $1" 1>&2
      exit 1
    fi
    BERT_MODEL=$2
    shift 1
    ;;
  -m)
    if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
      echo "$0: option requires an argument -- $1" 1>&2
      exit 1
    fi
    BERT_PARSING_MODEL_DIR=$2
    shift 1
    ;;
  -p)
    if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
      echo "$0: option requires an argument -- $1" 1>&2
      exit 1
    fi
    PYTHON_COMMAND=$2
    shift 1
    ;;
  -P)
    if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
      echo "$0: option requires an argument -- $1" 1>&2
      exit 1
    fi
    BERT_PARSING_COMMAND=$2
    shift 1
    ;;
  -o)
    if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
      echo "$0: option requires an argument -- $1" 1>&2
      exit 1
    fi
    BERT_PARSING_OPTIONS=$2
    shift 1
    ;;
  -O)
    if [[ -z "$2" ]] || [[ "$2" =~ ^-+ ]]; then
      echo "$0: option requires an argument -- $1" 1>&2
      exit 1
    fi
    BERT_PARSING_OPTIONS_FROM_FILE=$2
    shift 1
    ;;
  -tab)
    BERT_PARSING_OUTPUT_OPTIONS=""
    ;;
  -pyknp)
    BERT_PARSING_OPTIONS="$BERT_PARSING_OPTIONS --single_sentence"
    ;;
  -v | -version)
    version
    ;;
  -h | -help)
    usage
    ;;
  -*)
    usage
    ;;
  esac
  shift 1
done

if [ -n "$BERT_PARSING_OPTIONS_FROM_FILE" -a -f "$BERT_PARSING_OPTIONS_FROM_FILE" ]; then
  BERT_PARSING_OPTIONS=$(cat "$BERT_PARSING_OPTIONS_FROM_FILE")
fi

$PYTHON_COMMAND "$BERT_PARSING_COMMAND" --bert_model "$BERT_MODEL" --output_dir "$BERT_PARSING_MODEL_DIR" $BERT_PARSING_OPTIONS $BERT_PARSING_OUTPUT_OPTIONS
